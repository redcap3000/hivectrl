<!DOCTYPE html>
<html>
    <head>
		<title>Cryptoez</title>
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/styles.css"/>
    </head>
    <body>
        <div class="hiveContainer" id="hiveSelectedWorkerId">
        </div>
        <div class="hiveContainer" id="hiveSelectedCard">
        </div>
        <div class="hiveContainer" id="hiveSelectedIdxs">
        </div>
        <div class="hiveContainer" id="hiveFarmData">
        </div>
        <div class="hiveContainer" id="hiveHashrateData">
        </div>
        <div class="hiveContainer" id="hiveWorkersData">
        </div>


        <script>
            var rigs = {}
            var getData = true
            var dataInt = false
            var selectedCardIdxs=[]
            var selectedWorkerId=0
            var selectedCard=''
            function writeToDom(id,data){
                var docElement = document.getElementById(id)
                docElement.innerHTML=''
                if(typeof data != 'undefined' && typeof data.filter == 'function'){

                    data.filter(function(o){
                        docElement.innerHTML += o
                    })   
                }else{
                    if(typeof data != 'undefined'){
                        docElement.innerHTML = data
                    }
                }
            }

            getHiveData = function(){
                var endPoint = '/api'
                $.getJSON(endPoint,function(data){
                    console.log(data)
                    if(typeof data != 'undefined'){
                        console.log(data)
                        for(var farm in data){
                            var output=['<ul>']
                            var f = data[farm]
                            var fieldsNames=[
                                'Idle Power Draw',
                                'Farm Name',
                                'Price Per Watt',
                                'Rig Count',
                                'Workers Online',
                                'Timezone',
                            ]
                            var values = [
                            f.hardware_power_draw,
                            f.name,
                            f.power_price,
                            f.rigs_count,
                            f.stats.workers_online,
                            f.timezone
                            //f.hashrates_by_coin.coin,
                            //f.hashrates_by_coin.algo,
                            //f.hashrates_by_coin.hashrate
                            ]
                            values.filter(function(val,idx){
                                var keyName = fieldsNames[idx]
                                output.push('<li>'+keyName+' : '+val+'</li>')
                            })
                            output.push('</ul>')

                            var hashrates_by_coin=['<ul><li>hashrates by coin</li>']
                            f.hashrates_by_coin.filter(function(hr){
                                var hrate_check = parseFloat(hr.hashrate)
                                if(hrate_check < 1.0){
                                    hr.hashrate =(hrate_check*1000).toFixed(2) + ' h/s' 
                                    
                                }else if(hrate_check > 1000){
                                    hr.hashrate =(hrate_check/1000).toFixed(3) + ' kh/s' 
                                    
                                }else if(hrate_check > 10000){
                                    hr.hashrate =(hrate_check/10000).toFixed(4) + ' mh/s' 
                                    
                                }
                                hashrates_by_coin.push("<li>"+hr.coin + ' / ' + hr.algo + ' : ' + hr.hashrate + "</li>")
                            })
                            hashrates_by_coin.push('</ul>')
                        
                            var workers_digest=['<ul>']
                            var workerClickGuids = []
                            for(var workerId in f.workers){
                                var theWorker = f.workers[workerId]
                                workers_digest.push('<li><b>Worker : '+workerId+'</b></li>')
                                for(var gpuModel in theWorker.gpus){
                                    var wrk = theWorker.gpus[gpuModel]
                                    // need to cross reference workerId here..
                                    var domGuid = 'w-'+workerId
                                    // generate guid from gpu indexes
                                    wrk.filter(function(ww){
                                        domGuid += '_'+ww.idx
                                    })

                                    workers_digest.push('<li id="'+domGuid+'">' + gpuModel + ' ')
                                    //attach click handler
                                    workerClickGuids.push(domGuid)
                                    wrk.filter(function(w){
                                        workers_digest.push('<span>'+w.idx+'&nbsp;</span>')
                                    })
                                    workers_digest.push('</li>')
                                }
                            }
                            workers_digest.push('</ul>')

                        }
                        if(output.length > 2){
                            writeToDom('hiveFarmData',output)
                            
                        }
                        if(hashrates_by_coin.length > 2){
                            writeToDom('hiveHashrateData',hashrates_by_coin)
                        }
                        if(workers_digest.length > 2){
                            var docElement = document.getElementById('hiveWorkersData')
                            docElement.innerHTML=''
                            workers_digest.filter(function(o){
                                docElement.innerHTML += o
                            })
                            writeToDom('hiveWorkersData',workers_digest)
                            if(workerClickGuids.length > 0){
                                workerClickGuids.filter(function(wrkr){
                                    document.getElementById(wrkr).addEventListener("click",function(){
                                        var idxs= wrkr.split('_')
                                        var workerId=idxs.shift()
                                        selectedCard= this.innerHTML.trim('')
                                        selectedCardIdxs=idxs
                                        selectedWorkerId=workerId.split('-')[1]
                                        // these are the indexes.. 

                                    })
                                    
                                })
                            }
                            // add click handlers   
                        }
                    }
                })
            }
            getHiveData()
            // listen to changes initated by click handler
            setInterval(
                function(){
                    if(selectedCardIdxs.length > 0){
                        var sCardString = ['<ul>']
                        selectedCardIdxs.filter(function(c){
                            sCardString.push('<li>'+c+'</li>')
                        })
                        sCardString.push('</ul>')
                        writeToDom('hiveSelectedIdxs',sCardString)
                    }
                    if(selectedWorkerId  !== 0){
                        //document.getElementById('hiveSelectedWorkerId').innerHTML = selectedWorkerId
                        writeToDom('hiveSelectedWorkerId',selectedWorkerId)
                        
                    }
                    if(selectedCard  != ''){
                        //document.getElementById('hiveSelectedCard').innerHTML = selectedCard
                        writeToDom('hiveSelectedCard',selectedCard)
                        
                    }
                },1000
            )
            if(getData === true){
                dataInt = setInterval(function(){
                    getHiveData()
                },1000 * 10)
            }else{
                dataInt = false
            }
        </script>

	</body>
</html>