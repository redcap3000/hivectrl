<!DOCTYPE html>
<html>
    <head>
		<title>Cryptoez</title>
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/styles.css"/>
    </head>
    <body>
        <div class="hiveContainer" id="hiveSelectedWorkerId">
        </div>
        <div class="hiveContainer" id="hiveSelectedCard">
        </div>
        <div class="hiveContainer" id="hiveSelectedIdxs">
        </div>
        <div class="hiveContainer" id="hiveFarmData">
        </div>
        <div class="hiveContainer" id="hiveHashrateData">
        </div>
        <div class="hiveContainer" id="hiveWorkersData">
        </div>


        <script>
            var rigs = {}
            var getData = true
            var dataInt = false
            var selectedCardIdxs=[]
            var selectedWorkerId=0
            var selectedCard=''
            function writeToDom(id,data){
                var docElement = document.getElementById(id)
                docElement.innerHTML=''
                if(typeof data != 'undefined' && typeof data.filter == 'function'){

                    data.filter(function(o){
                        docElement.innerHTML += o
                    })   
                }else{
                    if(typeof data != 'undefined'){
                        docElement.innerHTML = data
                    }
                }
            }
            function convertHashrate(num){
                var hrate_check = parseFloat(num)
                if(!hrate_check){
                    return false
                }
                if(hrate_check < 1.0){
                    hr =(hrate_check*1000).toFixed(2) + ' h/s' 
                    
                }else if(hrate_check > 1000){
                    hr =(hrate_check/1000).toFixed(3) + ' kh/s' 
                    
                }else if(hrate_check > 10000){
                    hr =(hrate_check/10000).toFixed(4) + ' mh/s' 
                    
                }
                return hr
            }
            getHiveData = function(){
                var endPoint = '/api'
                $.getJSON(endPoint,function(data){
                    console.log(data)
                    if(typeof data != 'undefined'){
                        var minerStats= data.minerstats
                        /*
                            {467468: Array(2)}467468: Array(2)0: algo: "cuckaroo29s"bus_numbers: (6) [1, 4, 5, 12, 13, 16]coin: "XWP"fans: (6) [33, 26, 38, 26, 22, 22]hashes: (6) [0.0046500000000000005, 0.00319, 0.00459, 0.00309, 0.00316, 0.00315]miner: "gminer"temps: (6) [62, 66, 63, 66, 64, 64]__proto__: Object1: {miner: "cryptodredge", algo: "mtp", coin: "XZC", hashes: Array(5), temps: Array(5), …}length: 2__proto__: Array(0)__proto__: Object

                        */
                        // reform minerStats for easier referencing ?
                        var minerStatsRef={}

                        for(var farm in data.farms){

                             var minerStats_digest=['<ul>']
                            var miners_stats =[]
                             for(var workerId in minerStats){
                                var miners = minerStats[workerId]
                                miners.filter(function(w){
                                    if(typeof minerStatsRef[workerId] == 'undefined'){
                                        minerStatsRef[workerId] ={}
                                    }
                                    var minerWorkerGuid=w.miner+'_'+w.algo+'_'+w.coin

                                    if(typeof minerStatsRef[workerId][w.miner] == 'undefined'){

                                    }
                                    var concatDatas=[]
                                    w.bus_numbers.filter(function(b,i){
                                         // card title
                                        // force string for lookup
                                        var b2 = b+''
                                        var row = {
                                       //     cardTitle : workers_ref[workerId][b2],
                                            workerId : workerId,
                                            bus_number : b,
                                            fans : w.fans[i],
                                            hashes: w.hashes[i],
                                            temps : w.temps[i],
                                            algo : w.algo
                                        }
                                       
                                       // var workerCardTitle = workers_ref[workerId][b2]
                                        if(typeof miners_stats[workerId] == 'undefined'){
                                            miners_stats[workerId] = {}
                                        }
                                        if(typeof miners_stats[workerId][b2] == 'undefined'){
                                            miners_stats[workerId][b2] ={}
                                        }
                                        miners_stats[workerId][b2]=row
                                    })
                                    // bus_numbers
                                    // fans
                                    // hashes
                                    // temps

                                })
                            }

                            var output=['<ul>']
                            var f = data.farms[farm]
                            var fieldsNames=[
                                'Idle Power Draw',
                                'Farm Name',
                                'Price Per Watt',
                                'Rig Count',
                                'Workers Online',
                                'Timezone',
                            ]
                            var values = [
                            f.hardware_power_draw,
                            f.name,
                            f.power_price,
                            f.rigs_count,
                            f.stats.workers_online,
                            f.timezone
                            //f.hashrates_by_coin.coin,
                            //f.hashrates_by_coin.algo,
                            //f.hashrates_by_coin.hashrate
                            ]
                            values.filter(function(val,idx){
                                var keyName = fieldsNames[idx]
                                output.push('<li>'+keyName+' : '+val+'</li>')
                            })
                            output.push('</ul>')

                            var hashrates_by_coin=['<ul><li>hashrates by coin</li>']
                            f.hashrates_by_coin.filter(function(hr){
                                var hrate_check = parseFloat(hr.hashrate)
                                if(hrate_check < 1.0){
                                    hr.hashrate =(hrate_check*1000).toFixed(2) + ' h/s' 
                                    
                                }else if(hrate_check > 1000){
                                    hr.hashrate =(hrate_check/1000).toFixed(3) + ' kh/s' 
                                    
                                }else if(hrate_check > 10000){
                                    hr.hashrate =(hrate_check/10000).toFixed(4) + ' mh/s' 
                                    
                                }
                                hashrates_by_coin.push("<li>"+hr.coin + ' / ' + hr.algo + ' : ' + hr.hashrate + "</li>")
                            })
                            hashrates_by_coin.push('</ul>')
                        
                            var workers_digest=['<ul>']
                            var workers_ref={}
                            var workerClickGuids = []
                            for(var workerId in f.workers){
                                var theWorker = f.workers[workerId]
                                workers_digest.push('<li><b>Worker : '+workerId+'</b></li>')
                                for(var gpuModel in theWorker.gpus){
                                    var wrk = theWorker.gpus[gpuModel]
                                    // need to cross reference workerId here..
                                    var domGuid = 'w-'+workerId
                                    // generate guid from gpu indexes
                                    wrk.filter(function(ww){
                                        domGuid += '_'+ww.idx
                                    })

                                    workers_digest.push('<li id="'+domGuid+'">' + gpuModel + ' ')
                                    //attach click handler
                                    workerClickGuids.push(domGuid)
                                    wrk.filter(function(w){
                                    
                                        
                                        console.log(workerId)
                                        var cardStats=undefined
                                        
                                        if(typeof miners_stats[workerId] != 'undefined' && typeof miners_stats[workerId][w.bus_number+''] != 'undefined'){
                                            cardStats = miners_stats[workerId][w.bus_number+'']

                                            workers_digest.push('<table><tr><th>'+w.idx+'</th><td>'+cardStats.fans+'%</td><td>'+cardStats.algo+'&nbsp;'+convertHashrate(cardStats.hashes)+'</td></tr></table>')

                                        }else{
                                            workers_digest.push('<span>'+w.idx+'</span>')
                                        }

                                        // fans hashes temps
                                        
                                        // for combining with data below
                                        if(typeof workers_ref[workerId] == 'undefined'){
                                            workers_ref[workerId]={}
                                        }
                                        if(typeof workers_ref[workerId][w.bus_number] == 'undefined'){
                                            workers_ref[workerId][w.bus_number]={}
                                        }
                                        // data to pass/ref
                                        workers_ref[workerId][w.bus_number]=gpuModel
                                        

                                    })
                                    workers_digest.push('</li>')

                                       
                                }
                            }
                            console.log(workers_ref)
                            workers_digest.push('</ul>')


                           

                        }
                        if(output.length > 2){
                            writeToDom('hiveFarmData',output)
                            
                        }
                        if(hashrates_by_coin.length > 2){
                            writeToDom('hiveHashrateData',hashrates_by_coin)
                        }
                        if(workers_digest.length > 2){
                            var docElement = document.getElementById('hiveWorkersData')
                            docElement.innerHTML=''
                            workers_digest.filter(function(o){
                                docElement.innerHTML += o
                            })
                            writeToDom('hiveWorkersData',workers_digest)
                            if(workerClickGuids.length > 0){
                                workerClickGuids.filter(function(wrkr){
                                    document.getElementById(wrkr).addEventListener("click",function(){
                                        var idxs= wrkr.split('_')
                                        var workerId=idxs.shift()
                                        selectedCard= this.innerHTML.trim('')
                                        selectedCardIdxs=idxs
                                        selectedWorkerId=workerId.split('-')[1]
                                        // these are the indexes.. 

                                    })
                                    
                                })
                            }
                            // add click handlers   
                        }

                    }
                })
            }
            getHiveData()
            // listen to changes initated by click handler
            setInterval(
                function(){
                    if(selectedCardIdxs.length > 0){
                        var sCardString = ['<ul>']
                        selectedCardIdxs.filter(function(c){
                            sCardString.push('<li>'+c+'</li>')
                        })
                        sCardString.push('</ul>')
                        writeToDom('hiveSelectedIdxs',sCardString)
                    }
                    if(selectedWorkerId  !== 0){
                        //document.getElementById('hiveSelectedWorkerId').innerHTML = selectedWorkerId
                        writeToDom('hiveSelectedWorkerId',selectedWorkerId)
                        
                    }
                    if(selectedCard  != ''){
                        //document.getElementById('hiveSelectedCard').innerHTML = selectedCard
                        writeToDom('hiveSelectedCard',selectedCard)
                        
                    }
                },1000
            )
            if(getData === true){
                dataInt = setInterval(function(){
                    getHiveData()
                },1000 * 10)
            }else{
                dataInt = false
            }
        </script>

	</body>
</html>